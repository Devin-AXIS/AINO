# 数据库开发约束

## 概述
为了确保系统未来能够平滑扩展（读写分离、分区、缓存等），所有数据库相关开发必须遵循以下6条约束。这些约束成本几乎为0，但能确保未来扩展时无需修改现有代码。

## 6条核心约束

### 1. 字段统一
**要求**：每张表必须包含以下标准字段
- `id`: uuid/cuid 主键
- `created_at`: timestamp，默认 now()
- `updated_at`: timestamp，默认 now()

**示例**：
```typescript
export const exampleTable = pgTable("example_table", {
  id: uuid("id").primaryKey().defaultRandom(),
  // ... 业务字段
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
})
```

### 2. 索引最少集
**要求**：
- `created_at` 字段必须有索引
- 常用过滤条件（如 `tenant_id`, `status`, `application_id`）必须建组合索引

**示例**：
```typescript
export const exampleTable = pgTable("example_table", {
  // ... 字段定义
}, (table) => ({
  createdAtIdx: index("created_at_idx").on(table.createdAt),
  tenantStatusIdx: index("tenant_status_idx").on(table.tenantId, table.status),
}))
```

### 3. 分页一律键集
**要求**：列表类查询禁止使用 OFFSET，必须使用键集分页

**❌ 错误示例**：
```typescript
// 禁止使用 OFFSET
.offset((page - 1) * limit)
```

**✅ 正确示例**：
```typescript
// 使用键集分页
.where(lt(table.createdAt, cursor))
.orderBy(desc(table.createdAt))
.limit(limit)
```

**注意**：当前项目仍使用 OFFSET 分页，新功能开发时建议使用键集分页。

### 4. 单连接池
**要求**：应用内只创建两个 Pool（读/写），不要每请求建连接

**✅ 正确示例**：
```typescript
// 全局连接池
const pool = new Pool({ connectionString: PG_URL })
export const db = drizzle(pool, { schema })
```

### 5. 事务短小
**要求**：
- 事务里不做网络 IO
- 避免长事务与大范围锁
- 事务逻辑简单直接

**✅ 正确示例**：
```typescript
await db.transaction(async (tx) => {
  await tx.insert(table1).values(data1)
  await tx.update(table2).set(data2)
})
```

### 6. 不写原生 SQL
**要求**：只用 Drizzle ORM，迁移里少量 DDL 例外

**❌ 错误示例**：
```typescript
// 禁止原生 SQL
await db.query('SELECT * FROM users WHERE id = $1', [id])
```

**✅ 正确示例**：
```typescript
// 使用 Drizzle
await db.select().from(users).where(eq(users.id, id))
```

## 当前项目状态

### ✅ 已符合的约束
- [x] 字段统一：所有表都有标准字段
- [x] 单连接池：只有一个 Pool 实例
- [x] 事务短小：使用 Drizzle，事务简单
- [x] 不写原生 SQL：完全使用 Drizzle

### ✅ 已改进的约束
- [x] 索引最少集：已添加所有必要的索引定义

## 未来扩展优势

遵循这些约束后，未来可以轻松实现：
- **读写分离**：读库只读，写库只写
- **数据库分区**：按时间或租户分区
- **缓存策略**：基于键集分页的缓存
- **数据库迁移**：换库时无需修改代码

## 检查清单

开发新功能时，请确认：
- [ ] 新表包含标准字段（id, created_at, updated_at）
- [ ] 添加了必要的索引（created_at 索引 + 常用过滤条件组合索引）
- [ ] 新功能分页建议使用键集而非 OFFSET
- [ ] 使用 Drizzle 而非原生 SQL
- [ ] 事务逻辑简单短小

---

**注意**：这些约束是为了未来的扩展性，不会影响当前功能的正常运行。
