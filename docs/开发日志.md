# AINO 开发日志

## 📋 文档说明

本文档记录 AINO 平台的开发过程，包括：
- 每次功能开发的总结
- 遇到的问题和解决方案
- 成功的开发方法
- 避免重复犯错的检查清单

---

## 🎯 开发原则

### 核心原则
1. **数据从API来**：前端永远从API获取数据，不使用本地状态管理真实数据
2. **操作后刷新**：任何修改操作后都要重新获取数据
3. **一次一个**：每次只开发一个功能，避免同时开发多个
4. **先测试后集成**：先确保API正常，再对接前端
5. **错误要处理**：所有可能的错误都要有处理

### 技术栈
- **后端**：Hono + Drizzle ORM + PostgreSQL
- **前端**：Next.js + React + TypeScript
- **数据验证**：Zod
- **架构模式**：三层架构 (Routes → Service → Repository)

---

## 📝 开发日志

### 2025-01-24 - 目录管理系统

#### ✅ 成功完成的功能
1. **目录创建**：支持模板选择和自定义目录
2. **目录显示**：从API获取真实数据，刷新后可见
3. **目录重命名**：实时同步到数据库
4. **目录删除**：包含安全检查，实时同步

#### ❌ 遇到的问题

**问题1：目录创建后刷新页面消失**
- **原因**：前端使用本地状态管理目录数据，刷新后丢失
- **解决方案**：
  - 在 `useApiBuilderController` 中添加 `fetchDirectories` 函数
  - 从API获取真实数据而不是本地状态
  - 操作后重新获取数据

**问题2：缺少目录API方法**
- **原因**：`AINO-studio/lib/api.ts` 中没有定义目录相关的API方法
- **解决方案**：
  - 添加 `directoriesApi` 对象
  - 包含完整的CRUD方法：`getDirectories`, `createDirectory`, `updateDirectory`, `deleteDirectory`

**问题3：数据流不一致**
- **原因**：前端hook中的目录数据来源混乱
- **解决方案**：
  - 统一使用API数据源
  - 移除本地状态管理
  - 确保数据流：API → Hook → 组件

#### 🎯 成功的开发方法

1. **API优先开发**：
   ```
   后端API → 前端API方法 → Hook对接 → 页面测试
   ```

2. **数据流设计**：
   ```
   数据库 → Repository → Service → Routes → API → Hook → 组件
   ```

3. **状态管理**：
   ```
   操作触发 → API调用 → 重新获取数据 → 更新状态 → 界面刷新
   ```

#### 📊 最终效果
- ✅ 目录创建后立即显示
- ✅ 刷新页面后数据仍然存在
- ✅ 重命名和删除操作实时同步
- ✅ 错误处理完善，用户友好提示

---

## 🔧 开发检查清单

### 后端开发检查
- [ ] DTO是否用Zod定义
- [ ] 是否遵循三层架构 (Routes → Service → Repository)
- [ ] 是否有权限检查
- [ ] 是否有错误处理
- [ ] 是否返回统一格式 `{success: true, data: ...}`
- [ ] 数据库操作是否正确
- [ ] 是否支持分页和过滤

### 前端开发检查
- [ ] API方法是否在 `api.ts` 中定义
- [ ] Hook是否调用真实API
- [ ] 数据是否从API获取（不是本地状态）
- [ ] 操作后是否重新获取数据
- [ ] 是否有错误提示
- [ ] 加载状态是否处理
- [ ] 用户权限是否检查

### 集成测试检查
- [ ] 前端页面是否正常显示
- [ ] 创建/更新/删除是否生效
- [ ] 刷新页面后数据是否还在
- [ ] 错误情况是否有友好提示
- [ ] 权限控制是否生效
- [ ] 性能是否可接受

---

## 🚀 开发模板

### 新功能开发流程
```
1. 需求分析 → 确定数据模型和API接口
2. 后端开发 → DTO → Repository → Service → Routes
3. 前端对接 → API方法 → Hook更新 → 页面测试
4. 验证测试 → API测试 → 前端测试 → 持久化测试
```

### API开发模板
```typescript
// 1. DTO定义
export const CreateXxxRequest = z.object({
  name: z.string().min(1),
  type: z.enum(['type1', 'type2']),
  config: z.record(z.any()).optional(),
})

export const XxxResponse = z.object({
  id: z.string(),
  name: z.string(),
  type: z.string(),
  createdAt: z.string(),
})

// 2. Repository层
export class XxxRepository {
  async create(data: CreateXxxRequest): Promise<XxxResponse> {
    const [result] = await db.insert(xxxTable).values(data).returning()
    return this.convertToResponse(result)
  }
  
  async findMany(query: GetXxxQuery): Promise<XxxListResponse> {
    // 实现查询逻辑
  }
}

// 3. Service层
export class XxxService {
  async create(data: CreateXxxRequest, userId: string): Promise<XxxResponse> {
    // 权限检查
    const hasAccess = await this.checkUserAccess(userId)
    if (!hasAccess) {
      throw new Error("没有权限")
    }
    
    // 业务逻辑
    return await this.repo.create(data)
  }
}

// 4. Routes层
app.post("/", zValidator("json", CreateXxxRequest), async (c) => {
  try {
    const data = c.req.valid("json")
    const user = c.get("user")
    const result = await service.create(data, user.id)
    return c.json({ success: true, data: result })
  } catch (error) {
    return c.json({ 
      success: false, 
      error: error instanceof Error ? error.message : "操作失败" 
    }, 400)
  }
})
```

### 前端API方法模板
```typescript
// AINO-studio/lib/api.ts
export const xxxApi = {
  async getXxxList(params: {
    applicationId: string
    page?: number
    limit?: number
  }): Promise<ApiResponse<any>> {
    const searchParams = new URLSearchParams()
    Object.entries(params).forEach(([key, value]) => {
      if (value !== undefined) {
        searchParams.append(key, value.toString())
      }
    })
    
    const queryString = searchParams.toString()
    const endpoint = `/api/xxx${queryString ? `?${queryString}` : ''}`
    
    return apiRequest<any>(endpoint)
  },

  async createXxx(data: any, params: any): Promise<ApiResponse<any>> {
    const searchParams = new URLSearchParams()
    Object.entries(params).forEach(([key, value]) => {
      if (value !== undefined) {
        searchParams.append(key, value.toString())
      }
    })
    
    const queryString = searchParams.toString()
    const endpoint = `/api/xxx${queryString ? `?${queryString}` : ''}`
    
    return apiRequest<any>(endpoint, {
      method: 'POST',
      body: JSON.stringify(data),
    })
  },
}
```

---

## 🎯 下一步开发计划

### 已完成功能
- ✅ 用户认证系统
- ✅ 应用管理
- ✅ 模块管理
- ✅ 目录管理

### 待开发功能
- 🔄 字段管理系统
- 🔄 动态表结构生成
- 🔄 记录管理
- 🔄 分类管理
- 🔄 权限系统
- 🔄 远程模块支持

---

## 📚 参考资料

- [产品文档](./产品文档.md)
- [技术文档](./技术文档.md)
- [开发约束文档](./每次开发前需要阅读的约束文档.md)

---

*最后更新：2025-01-24*

