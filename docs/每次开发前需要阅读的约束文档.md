AINO 开发约束（Cursor 专用）

目标：最小依赖、最轻后端、一次一个 API。前端样式/交互绝不修改，后端只负责 API，把前端本地数据替换为真实接口。

⸻

0. 总原则（必须遵守）
	•	最小依赖：只能用 hono、@hono/node-server、zod、@hono/zod-validator、drizzle-orm、pg（按需再加：hono/cors、hono/secure-headers、hono/compress、pino、rate-limiter-flexible）。
	•	最新版本：安装/升级默认最新稳定版；每日 pnpm outdated 检查。
	•	前后端职责：
	•	前端（已写好）：不得更改任何 UI/样式/交互/路由。
	•	后端：只实现 API，把本地数据源换成真实接口。
	•	一次一个 API：每次只对接一个页面的一个接口；通过后再下一个。
	•	禁止工程化：不引入脚手架/装饰器/IOC/AOP/黑箱代码生成器/多租户等复杂度。
	•	允许（受控）自动生成 API：可基于“自定义字段/目录/模块配置”动态注册 CRUD 路由；生成逻辑必须可读可调试，仍走 Zod 校验，允许局部覆盖。
禁止手写 SQL：所有查询/写入必须使用 Drizzle ORM，不得写原生 SQL（除非 Drizzle 无法表达且经团队确认）。
禁止更换框架：后端必须基于 Hono + Drizzle ORM + Postgres，不得引入其他后端框架（如 Express、Fastify、Nest 等）。

1. 目录与脚本（后端最小形态）

AINO-server/
  src/
    app.ts              # Hono 实例 + 中间件（CORS/安全头/压缩/限流）
    server.ts           # 启动
    env.ts              # 环境变量校验（Zod）
    db/
      index.ts          # pg Pool + drizzle 实例
      schema.ts         # 只有“平台元数据 + 核心目录”几张表
    platform/
      identity.ts       # 统一用户上下文（身份契约）
      modules/
        registry.ts     # 模块注册（本地/远程）
        proxy.ts        # 远程模块代理（HMAC）
        manifest.ts     # Manifest 类型（Zod）
    modules/
      users/            # 示例：用户模块（最小必需）
        routes.ts
        service.ts
        repo.ts
        dto.ts
      catalog/          # 你的业务模块（示例）
        routes.ts
        service.ts
        repo.ts
        dto.ts

package.json（必须有）

{
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "build": "tsc -p .",
    "start": "node dist/server.js",
    "lint:types": "tsc -p . --noEmit",
    "deps:check": "pnpm outdated || true"
  }
}


⸻

2. 开发流程（DoR / DoD）

DoR（开始前）
	1.	明确该接口的 URL/Method/Query/Body/Response（来自前端约定，禁止改结构）。
	2.	在 dto.ts 写 Zod 请求/响应。
	3.	新建 routes.ts，用 zValidator 校验；service.ts 先 mock 返回。

DoD（完成标准）
	•	前端页面已把本地数据替换成该 API，功能正常。
	•	pnpm run lint:types 无错误。
	•	路由只用 c.req.valid() 的数据；routes → service → repo 三层清晰。
	•	若连库：repo.ts 键集分页、只选必要列、批量用 IN/JOIN、写入用 UPSERT/幂等。

⸻

3. 依赖策略（最小 + 最新）

允许安装（核心）
	•	运行时：hono、@hono/node-server、zod、@hono/zod-validator、（连库时）drizzle-orm、pg
	•	开发：typescript、tsx、@types/node

按需可选（确认再加）
	•	安全/通用：hono/cors、hono/secure-headers、hono/compress
	•	日志：pino（生产禁 pretty）
	•	限流：rate-limiter-flexible（对写接口建议开启）
	•	文档：@hono/zod-openapi（需要才上）

禁止：大型全家桶、模板引擎、装饰器路由、ORM 以外数据层库、复杂中间件框架。

版本与升级
	•	新装默认最新：pnpm add <pkg>
	•	每日检查：pnpm run deps:check
	•	升级后回归：pnpm run lint:types、/health、当前页面功能。

⸻

4. 编码规范（极简但不乱）

4.1 路由（只做接入与校验）

// routes.ts
import { Hono } from "hono"
import { zValidator } from "@hono/zod-validator"
import { ReqDTO, RespDTO } from "./dto"
import { doStuff } from "./service"

export const route = new Hono()

route.get("/list", zValidator("query", ReqDTO), async (c) => {
  const q = c.req.valid("query")
  const data = await doStuff(q)           // 只调 service
  return c.json({ success: true, data } satisfies RespDTO)
})

4.2 服务层（先 mock，后接库）

// service.ts
import type { TReqDTO } from "./dto"
import { repoFind } from "./repo"

export async function doStuff(q: TReqDTO) {
  // 初期 mock：先让前端切到真实 API
  // return { items: [], nextCursor: null }

  // 接库后：
  const { rows, nextCursor } = await repoFind(q)
  return { items: rows, nextCursor }
}

4.3 数据层（只做 SQL/查询范式）
	•	键集分页 替代 offset；只选必要列；批量用 IN/JOIN；写入 UPSERT。
	•	不做业务判断/不拼 JSON，只返回原始数据。

⸻

5. 性能约束（数据库优先）

5.1 连接池（唯一入口）

// db/index.ts
import { drizzle } from "drizzle-orm/node-postgres"
import { Pool } from "pg"
export const db = drizzle(new Pool({
  connectionString: process.env.PG_URL!,
  max: 10, idleTimeoutMillis: 10000, connectionTimeoutMillis: 3000
}))

开发阶段不强制 PgBouncer；生产建议 PgBouncer（pool_mode=transaction）。

5.2 键集分页（强制）

// repo.ts 例（按 created_at 降序）
import { db } from "../../db"
import { items } from "../../db/schema"
import { and, desc, eq, lt } from "drizzle-orm"

export async function repoFind(q:{size:number;cursor?:Date;status?:"draft"|"active"}) {
  const where = and(q.status ? eq(items.status, q.status) : undefined,
                    q.cursor ? lt(items.createdAt, q.cursor) : undefined)
  const rows = await db.select({
      id: items.id, name: items.name, status: items.status, createdAt: items.createdAt
    }).from(items).where(where).orderBy(desc(items.createdAt)).limit(q.size + 1)
  const nextCursor = rows.length > q.size ? rows[q.size - 1].createdAt : null
  return { rows: rows.slice(0, q.size), nextCursor }
}

5.3 查询与写入
	•	只选必要列：避免“SELECT *”。
	•	批量：用 IN/JOIN，避免 N+1。
	•	写入：UPSERT + Idempotency-Key（防重）。
	•	索引：只对热点接口上线前加（如 status + created_at、JSONB→GIN/生成列 + 普通索引）。

⸻

6. 自动生成 API（允许但轻量）
	•	基于“自定义字段/目录/模块配置”在启动时动态注册 CRUD 路由（例如 /api/<key>/{list,create,update,delete}）。
	•	生成的路由必须走 Zod 校验（配置→Zod Schema）。
	•	生成逻辑可读可调试可覆盖；权限/用户上下文使用平台统一注入（user.id/roles）。

⸻

7. 运行与排错（Cursor 小白模式）
	•	启动：pnpm dev（保持该终端挂着）
	•	健康检查：/health 必须 200
	•	测试：在第二个终端用 curl 或 Postman
	•	常见问题：
	•	端口占用：lsof -i :3001 | awk 'NR>1{print $2}' | xargs kill -9
	•	类型报错：pnpm run lint:types，从第一个错开始修；类型用 z.infer
	•	Docker PG 连不上：先用 mock；需要时再开 Docker Desktop

⸻

8. 不允许（NEVER）
	•	改前端样式/交互/路由/组件命名
	•	同时开发多个接口（必须一次一个）
	•	引入不必要的库/复杂中间件/黑箱生成器
	•	在路由里写 SQL/业务（必须三层分离）
	•	写长事务/在事务里做网络 IO
	•	提交时存在 tsc 错误

⸻

9. 必须（ALWAYS）
	1.	每个接口都有 Zod DTO；路由只用 c.req.valid() 的数据。
	2.	先 mock 跑通，再接数据库。
	3.	每天跑：pnpm run lint:types、pnpm run deps:check。
	4.	所有变更先测 /health，再测当前页面的接口。

⸻
前端开发约束
1. **严禁修改用户的前端样式和布局** - 只修复功能性问题，保持用户原有的UI设计
2. **中英文切换功能必须保持原样** - 不要修改语言切换按钮的样式和逻辑
3. **API集成时保持原有交互模式** - 在替换mock数据时，保持用户熟悉的操作流程

### 后端开发约束
1. **API错误处理必须返回结构化JSON** - 避免返回空对象`{}`，始终返回`{success: false, error: "具体错误信息"}`
2. **状态码处理要统一** - 成功操作返回200/201，失败返回400/401/500，不要混用
3. **数据库字段类型要匹配** - UUID字段不能传入字符串ID，确保类型一致性
4. **slug生成要考虑多语言** - 中文名称应用需要特殊处理，避免生成空slug

### 前后端集成约束
1. **API响应格式必须一致** - 前端期望`{success: true, data: {...}}`格式，后端必须严格遵循
2. **认证token键名要统一** - 前后端使用相同的localStorage键名（如`aino_token`）
3. **数据获取要主动调用** - 如果hook设置了`autoFetch: false`，必须在useEffect中手动调用获取函数
4. **错误信息要用户友好** - 避免显示技术性错误，提供可操作的提示信息

### 数据库约束
1. **表结构要与schema定义一致** - 避免字段类型不匹配导致的插入失败
2. **外键约束要谨慎使用** - 在开发阶段可以暂时禁用，避免复杂的依赖关系
3. **UUID生成要使用数据库默认** - 让数据库自动生成UUID，避免手动生成导致的问题

---
---